<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Interactive Data Visualization Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #dashboard-container {
            margin: 20px;
        }
        .plot-container {
            margin-top: 30px;
        }
        .loading-indicator {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
<div id="dashboard-container" class="container">
    <h1>COVID-19 Interactive Data Visualization Dashboard</h1>
    <div class="form-group">
        <label for="country-select">Select Country to Visualize:</label>
        <select id="country-select" class="form-control" multiple>
        </select>
    </div>
    <div id="summary-output"></div>
    <div id="country-graph" class="plot-container"></div>
    <div class="plot-container">
        <h4>Total Overview Globally</h4>
        <div id="loading-indicator" class="loading-indicator">Loading...</div>
        <div id="world-graph"></div>
    </div>
</div>

<script>
    function fetchData(retryCount = 3) {
        return $.ajax({
            url: "https://api.covid19api.com/summary",
            type: "GET",
            dataType: "json"
        }).fail((jqXHR, textStatus, errorThrown) => {
            if (retryCount > 0) {
                console.warn(`Retrying... (${3 - retryCount + 1})`);
                fetchData(retryCount - 1);
            } else {
                console.error(`Error fetching data: ${textStatus}, ${errorThrown}`);
                alert('Failed to fetch data from the API. Please try again later.');
            }
        });
    }

    function updateCountryOptions(data) {
        const dropdown = $('#country-select');
        dropdown.empty();
        if (data.Countries && data.Countries.length > 0) {
            data.Countries.forEach(country => {
                dropdown.append(new Option(country.Country, country.Country));
            });
        } else {
            console.error('No country data available');
            alert('No country data available to display.');
        }
    }

    function updateWorldGraph(data) {
        if (!data.Countries || data.Countries.length === 0) {
            console.error('No country data available');
            alert('No data available for visualization.');
            return;
        }

        const countriesData = data.Countries;
        if (countriesData.length > 100) {
            console.log('Optimizing sorting for large dataset using heap-based selection');
            const topCountries = heapSelectTopCountries(countriesData, 10, (a, b) => b.TotalConfirmed - a.TotalConfirmed);
        } else {
            const topCountries = countriesData
                .slice() // Creating a shallow copy to avoid mutating the original data
                .sort((a, b) => b.TotalConfirmed - a.TotalConfirmed)
                .slice(0, 10);
        }
        const countryNames = topCountries.map(country => country.Country);
        const totalConfirmed = topCountries.map(country => country.TotalConfirmed);

        const trace = {
            x: countryNames,
            y: totalConfirmed,
            type: 'bar',
            name: 'Total Confirmed Cases'
        };

        const layout = {
            title: 'Top 10 Countries with Highest Confirmed Cases',
            xaxis: { title: 'Country' },
            yaxis: { title: 'Total Confirmed Cases' }
        };

        $('#loading-indicator').hide();
        Plotly.newPlot('world-graph', [trace], layout);
    }

    function heapSelectTopCountries(data, k, compareFn) {
        const heap = [];
        for (let i = 0; i < data.length; i++) {
            if (heap.length < k) {
                heap.push(data[i]);
                heap.sort(compareFn);
            } else if (compareFn(data[i], heap[0]) > 0) {
                heap[0] = data[i];
                heap.sort(compareFn);
            }
        }
        return heap;
    }

    function updateCountryGraph(selectedCountries, data) {
        if (!selectedCountries.length) {
            $('#country-graph').html('<h5>Select a Country to See Detailed Information</h5>');
            return;
        }

        const selectedCountriesSet = new Set(selectedCountries);
        const selectedData = data.Countries.filter(country => selectedCountriesSet.has(country.Country));

        const traces = [
            {
                x: selectedData.map(country => country.Country),
                y: selectedData.map(country => country.TotalConfirmed),
                type: 'bar',
                name: 'Total Confirmed'
            },
            {
                x: selectedData.map(country => country.Country),
                y: selectedData.map(country => country.TotalDeaths),
                type: 'bar',
                name: 'Total Deaths'
            },
            {
                x: selectedData.map(country => country.Country),
                y: selectedData.map(country => country.TotalRecovered),
                type: 'bar',
                name: 'Total Recovered'
            }
        ];

        const layout = {
            title: 'COVID-19 Statistics by Country',
            barmode: 'group',
            xaxis: { title: 'Country' },
            yaxis: { title: 'Count' }
        };

        Plotly.newPlot('country-graph', traces, layout);
    }

    $(document).ready(function () {
        $('#loading-indicator').show();
        fetchData().done(data => {
            updateCountryOptions(data);
            updateWorldGraph(data);

            $('#country-select').on('change', _.debounce(function () {
                const selectedCountries = $(this).val();
                updateCountryGraph(selectedCountries, data);
            }, 300));
        });
    });
</script>
</body>
</html>
